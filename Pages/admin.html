<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console - Mystery Hub</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <script>
        window.MYSTERY_HUB_CONFIG = {
            navbarClock: true
        };
    </script>
    <script src="../clock/clock.js"></script>
</head>
<body>
    <!-- Header with Navigation -->
    <header>
        <nav class="navbar">
            <div class="logo">
                <a href="../index.html">
                    <h1>Mystery<span>Hub</span></h1>
                </a>
            </div>
            <ul class="nav-links">
                <li><a href="index.html">Home Base</a></li>
                <li><a href="../games/game1.html">Field Operations</a></li>
                <li><a href="../blog/blog.html">Case Files</a></li>
                <li><a href="../movies/movies.html">Evidence Archive</a></li>
                <li class="active"><a href="admin.html">Admin Console</a></li>
            </ul>
            <div class="menu-toggle">
                <i class="fas fa-bars"></i>
            </div>
        </nav>
    </header>

    <!-- Admin Content -->
    <section class="main-content">
        <div class="admin-container">
            <div class="admin-header">
                <h1><i class="fas fa-shield-alt"></i> Administration Console</h1>
                <div class="clearance-stamp">LEVEL 10 CLEARANCE</div>
            </div>
            
            <div class="admin-panel">
                <div class="admin-sidebar">
                    <div class="admin-menu">
                        <div class="menu-item active" data-tab="users">
                            <i class="fas fa-users"></i> Agents
                        </div>
                        <div class="menu-item" data-tab="blogs">
                            <i class="fas fa-book-open"></i> Case Files
                        </div>
                        <div class="menu-item" data-tab="movies">
                            <i class="fas fa-film"></i> Movie Recs
                        </div>
                    </div>
                </div>
                
                <div class="admin-content">
                    <!-- Users Tab -->
                    <div class="tab-content active" id="users">
                        <div class="section-header">
                            <h2>Agent Files</h2>
                            <div class="action-buttons">
                                <button id="add-user-btn" class="action-btn">
                                    <i class="fas fa-user-plus"></i> Add New Agent
                                </button>
                            </div>
                        </div>
                        
                        
                        
                        <div class="blogs-table-container">
                            <table class="admin-table blogs-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Expertise</th>
                                        <th>Join Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="user-table-body">
                                    <!-- User data will be loaded here dynamically -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Loading indicator -->
                        <div id="users-loading" class="loading-indicator">
                            <i class="fas fa-circle-notch fa-spin"></i> Loading agents...
                        </div>
                        
                        <!-- No users message -->
                        <div id="no-users-message" class="no-data-message" style="display: none;">
                            <i class="fas fa-user-slash"></i>
                            <p>No agents found.</p>
                        </div>
                    </div>
                    
                    <!-- Blogs Tab -->
                    <div class="tab-content" id="blogs">
                        <div class="section-header">
                            <h2>Case Files Management</h2>
                            <div class="action-buttons">
                                <a href="blog/upload.html" class="action-btn">
                                    <i class="fas fa-plus-circle"></i> Add New Case File
                                </a>
                            </div>
                        </div>
                        
                        
                        <div class="blogs-table-container">
                            <table class="admin-table blogs-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Title</th>
                                        <th>Category</th>
                                        <th>Author</th>
                                        <th>Date</th>
                                
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="blogs-table-body">
                                    <!-- Blog data will be loaded here dynamically -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Loading indicator -->
                        <div id="blogs-loading" class="loading-indicator">
                            <i class="fas fa-circle-notch fa-spin"></i> Loading case files...
                        </div>
                        
                        <!-- No blogs message -->
                        <div id="no-blogs-message" class="no-data-message" style="display: none;">
                            <i class="fas fa-folder-open"></i>
                            <p>No case files found.</p>
                        </div>
                    </div>
                    
                    <!-- Other tabs would go here -->
                    <div class="tab-content" id="games">
                        <h2>Field Operations Management</h2>
                        <p>Coming soon: Manage mystery games and content.</p>
                    </div>
                    
                    <div class="tab-content" id="movies">
                        <h2>Evidence Logs Management</h2>
                        <p>Coming soon: Manage movie recommendations.</p>
                    </div>
                    
                    <div class="tab-content" id="settings">
                        <h2>System Settings</h2>
                        <p>Coming soon: Configure system settings.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- User Modal Forms -->
    <div id="add-user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-plus"></i> Add New Agent</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="add-user-form">
                    <div class="form-group">
                        <label for="firstname">First Name</label>
                        <input type="text" id="firstname" name="firstname" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="lastname">Last Name</label>
                        <input type="text" id="lastname" name="lastname" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" name="username" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="confirm_password">Confirm Password</label>
                        <input type="password" id="confirm_password" name="confirm_password" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="expertise">Field Expertise</label>
                        <select id="expertise" name="expertise" class="form-control" required>
                            <option value="">Select expertise</option>
                            <option value="detective">Field Detective</option>
                            <option value="forensics">Forensic Analysis</option>
                            <option value="profiler">Criminal Profiling</option>
                            <option value="cryptography">Cryptography</option>
                            <option value="surveillance">Surveillance Operations</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="is_admin">Admin Privileges</label>
                        <select id="is_admin" name="is_admin" class="form-control">
                            <option value="0">Regular Agent</option>
                            <option value="1">Admin Agent</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-save"></i> Add Agent
                        </button>
                        <button type="button" class="cancel-btn" id="cancel-add-btn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="edit-user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-edit"></i> Edit Agent</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="edit-user-form">
                    <input type="hidden" id="edit-user-id" name="user_id">
                    <div class="form-group">
                        <label for="edit-firstname">First Name</label>
                        <input type="text" id="edit-firstname" name="firstname" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-lastname">Last Name</label>
                        <input type="text" id="edit-lastname" name="lastname" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-username">Username</label>
                        <input type="text" id="edit-username" name="username" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-email">Email</label>
                        <input type="email" id="edit-email" name="email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-password">Password (leave blank to keep current)</label>
                        <input type="password" id="edit-password" name="password" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="edit-expertise">Field Expertise</label>
                        <select id="edit-expertise" name="expertise" class="form-control" required>
                            <option value="">Select expertise</option>
                            <option value="detective">Field Detective</option>
                            <option value="forensics">Forensic Analysis</option>
                            <option value="profiler">Criminal Profiling</option>
                            <option value="cryptography">Cryptography</option>
                            <option value="surveillance">Surveillance Operations</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-is-admin">Admin Privileges</label>
                        <select id="edit-is-admin" name="is_admin" class="form-control">
                            <option value="0">Regular Agent</option>
                            <option value="1">Admin Agent</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-save"></i> Update Agent
                        </button>
                        <button type="button" class="cancel-btn" id="cancel-edit-btn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="delete-user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-exclamation-triangle"></i> Confirm Deletion</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this agent from the system?</p>
                <p class="warning-text">This action cannot be undone. All associated data will be permanently removed.</p>
                <input type="hidden" id="delete-user-id">
                <div class="form-actions">
                    <button type="button" class="danger-btn" id="confirm-delete-btn">
                        <i class="fas fa-trash"></i> Delete Agent
                    </button>
                    <button type="button" class="cancel-btn" id="cancel-delete-btn">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Delete confirmation modal for blogs -->
    <div id="delete-blog-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-exclamation-triangle"></i> Delete Case File</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this case file? This action cannot be undone.</p>
                <input type="hidden" id="delete-blog-id">
                <div class="form-actions">
                    <button type="button" class="submit-btn danger-btn" id="confirm-delete-blog-btn">
                        <i class="fas fa-trash-alt"></i> Delete
                    </button>
                    <button type="button" class="cancel-btn" id="cancel-delete-blog-btn">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Flash Message Container -->
    <div class="flash-messages"></div>
    
    <!-- Footer -->
    <footer>
        <div class="footer-container">
            <div class="footer-grid">
                <div class="footer-section">
                    <h3>Mystery Hub</h3>
                    <p>Your gateway to interactive mysteries, true crime stories, and detective films.</p>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <ul class="footer-links">
                        <li><a href="../index.html">Home Base</a></li>
                        <li><a href="../games/game1.html">Field Operations</a></li>
                        <li><a href="../blog/blog.html">Case Files</a></li>
                        <li><a href="../movies/movies.html">Evidence Archive</a></li>
                    </ul>
                </div>
            </div>
            <div class="copyright">
                <p>Mystery Hub | Bintu Jalloh & Michelle Lawson</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Variables for elements
            const menuItems = document.querySelectorAll('.menu-item');
            const tabContents = document.querySelectorAll('.tab-content');
            const addUserBtn = document.getElementById('add-user-btn');
            const addUserModal = document.getElementById('add-user-modal');
            const editUserModal = document.getElementById('edit-user-modal');
            const deleteUserModal = document.getElementById('delete-user-modal');
            const deleteBlogModal = document.getElementById('delete-blog-modal');
            const closeModals = document.querySelectorAll('.close-modal');
            const cancelAddBtn = document.getElementById('cancel-add-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const cancelDeleteBlogBtn = document.getElementById('cancel-delete-blog-btn');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const confirmDeleteBlogBtn = document.getElementById('confirm-delete-blog-btn');
            const addUserForm = document.getElementById('add-user-form');
            const editUserForm = document.getElementById('edit-user-form');
            const userTableBody = document.getElementById('user-table-body');
            const userSearch = document.getElementById('user-search');
            const userFilter = document.getElementById('user-filter');
            const blogSearch = document.getElementById('blog-search');
            const blogFilter = document.getElementById('blog-filter');
            const blogsTableBody = document.getElementById('blogs-table-body');
            const blogsLoading = document.getElementById('blogs-loading');
            const noBlogsMessage = document.getElementById('no-blogs-message');
            const usersLoading = document.getElementById('users-loading');
            const noUsersMessage = document.getElementById('no-users-message');
            
            // Tab switching
            menuItems.forEach(item => {
                item.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Remove active class from all tabs and contents
                    menuItems.forEach(i => i.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to current tab and content
                    this.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Modal functions
            function openModal(modal) {
                modal.style.display = 'block';
            }
            
            function closeModal(modal) {
                modal.style.display = 'none';
            }
            
            // Open modals
            addUserBtn.addEventListener('click', function() {
                openModal(addUserModal);
            });
            
            // Close modals with X button
            closeModals.forEach(btn => {
                btn.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    closeModal(modal);
                });
            });
            
            // Close modals with cancel buttons
            cancelAddBtn.addEventListener('click', function() {
                closeModal(addUserModal);
            });
            
            cancelEditBtn.addEventListener('click', function() {
                closeModal(editUserModal);
            });
            
            cancelDeleteBtn.addEventListener('click', function() {
                closeModal(deleteUserModal);
            });
            
            cancelDeleteBlogBtn.addEventListener('click', function() {
                closeModal(deleteBlogModal);
            });
            
            // Close modals when clicking outside
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    closeModal(e.target);
                }
            });
            
            // Load users data
            function loadUsers() {
                usersLoading.style.display = 'block';
                noUsersMessage.style.display = 'none';
                
                fetch('../Backend/Php/admin_users.php?action=get_all')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            displayUsers(data.data.users);
                        } else {
                            displayFlashMessage('error', data.message || 'Failed to load users');
                            noUsersMessage.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading users:', error);
                        displayFlashMessage('error', 'Failed to connect to the server');
                        noUsersMessage.style.display = 'block';
                    })
                    .finally(() => {
                        usersLoading.style.display = 'none';
                    });
            }
            
            // Display users in the table
            function displayUsers(users) {
                userTableBody.innerHTML = '';
                
                if (!users || users.length === 0) {
                    noUsersMessage.style.display = 'block';
                    return;
                }
                
                users.forEach(user => {
                    const row = document.createElement('tr');
                    
                    // Format date
                    const date = new Date(user.created_at);
                    const formattedDate = date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                     
                    // Create row
                    row.innerHTML = `
                        <td>${user.id.substring(0, 10)}...</td>
                        <td>${user.firstname} ${user.lastname}</td>
                        <td>${user.username}</td>
                        <td>${user.email}</td>
                        <td>${user.expertise}</td>
                        <td>${formattedDate}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="view-btn" data-id="${user.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="delete-btn" data-id="${user.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    userTableBody.appendChild(row);
                });
                
                // Add event listeners to buttons
                document.querySelectorAll('#user-table-body .view-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const userId = this.getAttribute('data-id');
                        window.location.href = `profile.html?id=${userId}`;
                    });
                });
                
                document.querySelectorAll('#user-table-body .edit-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const userId = this.getAttribute('data-id');
                        loadUserForEdit(userId);
                    });
                });
                
                document.querySelectorAll('#user-table-body .delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const userId = this.getAttribute('data-id');
                        openDeleteUserModal(userId);
                    });
                });
            }
            
            // Delete user
            let userToDelete = null;
            
            function openDeleteUserModal(userId) {
                userToDelete = userId;
                openModal(deleteUserModal);
            }
            
            function deleteUser(userId) {
                const formData = new FormData();
                formData.append('id', userId);
                
                fetch('../Backend/Php/admin_users.php?action=delete', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayFlashMessage('success', 'Agent deleted successfully');
                        loadUsers(); // Reload user list
                    } else {
                        displayFlashMessage('error', data.message || 'Failed to delete agent');
                    }
                })
                .catch(error => {
                    console.error('Error deleting user:', error);
                    displayFlashMessage('error', 'Failed to connect to the server');
                });
            }
            
            // Confirm delete user
            confirmDeleteBtn.addEventListener('click', function() {
                if (userToDelete) {
                    deleteUser(userToDelete);
                    closeModal(deleteUserModal);
                    userToDelete = null;
                }
            });
            
            // Load blogs data
            function loadBlogs() {
                blogsLoading.style.display = 'block';
                noBlogsMessage.style.display = 'none';
                
                fetch('../Backend/Php/admin_blogs.php?action=get_all')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            displayBlogs(data.data.blogs);
                        } else {
                            displayFlashMessage('error', data.message || 'Failed to load blogs');
                            noBlogsMessage.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading blogs:', error);
                        displayFlashMessage('error', 'Failed to connect to the server');
                        noBlogsMessage.style.display = 'block';
                    })
                    .finally(() => {
                        blogsLoading.style.display = 'none';
                    });
            }
            
            // Display blogs in the table
            function displayBlogs(blogs) {
                blogsTableBody.innerHTML = '';
                
                if (!blogs || blogs.length === 0) {
                    noBlogsMessage.style.display = 'block';
                    return;
                }
                
                blogs.forEach(blog => {
                    const row = document.createElement('tr');
                    
                    // Format date
                    const date = new Date(blog.createdAt);
                    const formattedDate = date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                    
                    // Featured image path
                    let featuredImage = blog.featuredImage;
                    if (!featuredImage) {
                        featuredImage = '../assets/images/default-blog-image.jpg';
                    } else if (featuredImage.indexOf('/') !== 0 && featuredImage.indexOf('http') !== 0) {
                        featuredImage = '../' + featuredImage;
                    }
                    
                    // Format category
                    const category = blog.category.replace(/-/g, ' ');
                    const categoryFormatted = category.charAt(0).toUpperCase() + category.slice(1);
                    
                    // Create row
                    row.innerHTML = `
                        <td>${blog.id.substring(0, 10)}...</td>
                       
                        <td>${blog.title}</td>
                        <td>${categoryFormatted}</td>
                        <td>${blog.author || 'Unknown'}</td>
                        <td>${formattedDate}</td>
                        <td><span class="status-badge status-published">${blog.status || 'Published'}</span></td>
                        <td>
                            <div class="action-buttons">
                                <a href="blog/post.html?id=${blog.id}" class="view-btn">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button class="delete-btn" data-id="${blog.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    blogsTableBody.appendChild(row);
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('#blogs-table-body .delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const blogId = this.getAttribute('data-id');
                        openDeleteBlogModal(blogId);
                    });
                });
            }
            
            // Delete blog
            function deleteBlog(blogId) {
                const formData = new FormData();
                formData.append('id', blogId);
                
                fetch('../Backend/Php/admin_blogs.php?action=delete', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayFlashMessage('success', 'Case file deleted successfully');
                        loadBlogs(); // Reload blog list
                    } else {
                        displayFlashMessage('error', data.message || 'Failed to delete case file');
                    }
                })
                .catch(error => {
                    console.error('Error deleting blog:', error);
                    displayFlashMessage('error', 'Failed to connect to the server');
                });
            }
            
            // Delete blog confirmation
            let blogToDelete = null;
            
            function openDeleteBlogModal(blogId) {
                blogToDelete = blogId;
                document.getElementById('delete-blog-id').value = blogId;
                openModal(deleteBlogModal);
            }
            
            confirmDeleteBlogBtn.addEventListener('click', function() {
                if (blogToDelete) {
                    deleteBlog(blogToDelete);
                    closeModal(deleteBlogModal);
                    blogToDelete = null;
                }
            });
            
            cancelDeleteBlogBtn.addEventListener('click', function() {
                closeModal(deleteBlogModal);
                blogToDelete = null;
            });
            
            // Load blogs on page load
            loadBlogs();
            
            // Load users on page load
            loadUsers();
            
            // Flash messages
            function displayFlashMessage(type, message, autoHide = true) {
                const flashContainer = document.querySelector('.flash-messages');
                
                const messageElement = document.createElement('div');
                messageElement.className = `flash-message flash-${type}`;
                
                let icon = '';
                switch (type) {
                    case 'success':
                        icon = '<i class="fas fa-check-circle"></i>';
                        break;
                    case 'error':
                        icon = '<i class="fas fa-exclamation-circle"></i>';
                        break;
                    case 'info':
                        icon = '<i class="fas fa-info-circle"></i>';
                        break;
                }
                
                messageElement.innerHTML = `${icon} ${message}<span class="flash-close"><i class="fas fa-times"></i></span>`;
                flashContainer.appendChild(messageElement);
                
                const closeButton = messageElement.querySelector('.flash-close');
                closeButton.addEventListener('click', function() {
                    messageElement.style.opacity = '0';
                    setTimeout(() => {
                        messageElement.remove();
                    }, 300);
                });
                
                if (autoHide) {
                    setTimeout(function() {
                        messageElement.style.opacity = '0';
                        setTimeout(() => {
                            messageElement.remove();
                        }, 300);
                    }, 5000);
                }
                
                return messageElement;
            }
        });
    </script>
</body>
</html>