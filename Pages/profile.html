<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Dossier - Mystery Hub</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <script>
        window.MYSTERY_HUB_CONFIG = {
            navbarClock: true
        };
    </script>
    <script src="../clock/clock.js"></script>
    <style> 
    </style>
</head>
<body>
    <!-- Header with Navigation -->
    <header>
        <nav class="navbar">
            <div class="logo">
                <a href="../index.html">
                    <h1>Mystery<span>Hub</span></h1>
                </a>
            </div>
            <ul class="nav-links">
                <li><a href="../index.html">Home Base</a></li>
                <li><a href="../games/game1.html">Field Operations</a></li>
                <li><a href="../blog/blog.html">Case Files</a></li>
                <li><a href="../movies/movies.html">Evidence Archive</a></li>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li class="profile-pic">
                    <img src="https://i.pravatar.cc/150?img=12" alt="User Profile">
                </li>
            </ul>
            <div class="menu-toggle">
                <i class="fas fa-bars"></i>
            </div>
        </nav>
    </header>

    <!-- Profile Content -->
    <section class="main-content">
        <div class="container">
            <div class="profile-container">
                <!-- Agent Dossier Header -->
                <div class="agent-dossier">
                    <div class="file-number">AGENT FILE #MH-2025-1142</div>
                    <div class="clearance-stamp">Level 3 Clearance</div>
                    
                    <div class="agent-photo-container">
                        <div class="photo-paperclip"></div>
                        <div class="agent-photo">
                            <img id="profile-picture-display" src="../profile_pics/default-profile.jpg" alt="Profile Picture">
                        </div>
                    </div>
                    
                    <div class="agent-info">
                        <h2 class="agent-code-name">Agent Jane D.</h2>
                        <div class="agent-codename">Codename: "Mystery Seeker"</div>
                        
                        <div class="agent-details">
                            <div class="agent-detail">
                                <div class="detail-label">Status:</div>
                                <div class="detail-value">Active Field Agent</div>
                            </div>
                            <div class="agent-detail">
                                <div class="detail-label">Division:</div>
                                <div class="detail-value">Investigation & Analysis</div>
                            </div>
                            <div class="agent-detail">
                                <div class="detail-label">Joined:</div>
                                <div class="detail-value">January 15, 2025</div>
                            </div>
                            <div class="agent-detail">
                                <div class="detail-label">Bio:</div>
                                <div class="detail-value" id="agent-bio">No field notes available.</div>
                            </div>
                      
                        </div>
                        
                        <div class="agent-stats">
                            <div class="agent-stat">
                                <i class="fas fa-gamepad"></i> 5 Field Operations
                            </div>
                            <div class="agent-stat">
                                <i class="fas fa-book-open"></i> 8 Case Files
                            </div>
                            <div class="agent-stat">
                                <i class="fas fa-film"></i> 12 Evidence Logs
                            </div>
                        </div>
                        
                        <button class="edit-profile-btn" id="edit-profile-btn">
                            <i class="fas fa-pen"></i> Update Agent File
                        </button>
                        <div id="editProfileModal" class="modal">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h2><i class="fas fa-user-edit"></i> Update Agent File</h2>
                                    <span class="close-modal">&times;</span>
                                </div>
                                <div class="modal-body">
                                    <form id="profile-form" enctype="multipart/form-data">
                                        <div class="form-group">
                                            <label for="profile-picture-upload">Profile Picture</label>
                                            <div class="profile-picture-container">
                                                <img id="profile-picture" src="../profile_pics/default-profile.jpg" alt="Agent Photo">
                                                <input type="file" id="profile-picture-upload" name="profile_picture" accept="image/*" class="form-control">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="firstname">First Name</label>
                                            <input type="text" id="firstname" name="firstname" class="form-control" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="lastname">Last Name</label>
                                            <input type="text" id="lastname" name="lastname" class="form-control" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="email">Email</label>
                                            <input type="email" id="email" name="email" class="form-control" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="username">Username</label>
                                            <input type="text" id="username" name="username" class="form-control" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="expertise">Field Expertise</label>
                                            <select id="expertise" name="expertise" class="form-control" required>
                                                <option value="">Select expertise</option>
                                                <option value="detective">Field Detective</option>
                                                <option value="forensics">Forensic Analysis</option>
                                                <option value="profiler">Criminal Profiling</option>
                                                <option value="cryptography">Cryptography</option>
                                                <option value="surveillance">Surveillance Operations</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="bio">Field Notes</label>
                                            <textarea id="bio" name="bio" rows="4" class="form-control" required></textarea>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="submit" class="submit-btn" id="submit-btn">
                                                <i class="fas fa-save"></i> Save Changes
                                            </button>
                                            <button type="button" class="cancel-btn" id="cancel-edit-btn">
                                                <i class="fas fa-times"></i> Cancel
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                
                <!-- Profile Tabs -->
                <div class="dossier-tabs">
                    <div class="dossier-tab active" data-tab="field-ops">Field Operations</div>
                    <div class="dossier-tab" data-tab="case-files">Case Files</div>
                    <div class="dossier-tab" data-tab="evidence-logs">Evidence Logs</div>
                    <div class="dossier-tab" data-tab="agent-settings">Agent Settings</div>
                </div>
                
                <div class="dossier-content">
                    <!-- Field Operations Tab -->
                    <div class="tab-content active" id="field-ops">
                        <h3 class="dossier-section-title">ACTIVE FIELD OPERATIONS</h3>
                        <div class="case-files-grid">
                            <div class="case-file-item">
                                <div class="case-file-img">
                                    <img src="https://images.unsplash.com/photo-1599707367072-cd6ada2bc375?q=80&w=1000" alt="Mystery Game">
                                </div>
                                <div class="case-file-content">
                                    <span class="case-file-category">Field Operation</span>
                                    <h3 class="case-file-title">The Vanishing Artifact</h3>
                                    <p class="case-file-meta">Progress: 75% Complete</p>
                                </div>
                            </div>
                            
                            <div class="case-file-item">
                                <div class="case-file-img">
                                    <img src="https://images.unsplash.com/photo-1444703686981-a3abbc4d4fe3?q=80&w=1000" alt="Mystery Game">
                                </div>
                                <div class="case-file-content">
                                    <span class="case-file-category">Field Operation</span>
                                    <h3 class="case-file-title">Murder at Midnight</h3>
                                    <p class="case-file-meta">Progress: 100% Complete</p>
                                </div>
                            </div>
                            
                            <div class="case-file-item">
                                <div class="case-file-img">
                                    <img src="https://images.unsplash.com/photo-1635614017406-7c192d1f8b76?q=80&w=1000" alt="Mystery Game">
                                </div>
                                <div class="case-file-content">
                                    <span class="case-file-category">Field Operation</span>
                                    <h3 class="case-file-title">Escape the Crypt</h3>
                                    <p class="case-file-meta">Status: Not Started</p>
                                </div>
                            </div>
                        </div>
                        <div class="fingerprint-bg"></div>
                    </div>
                    
                    <!-- Case Files Tab -->
                    <div class="tab-content" id="case-files">
                        <h3 class="dossier-section-title">ARCHIVED CASE FILES</h3>
                        <div class="case-files-grid">
                            <div class="case-file-item">
                                <div class="case-file-img">
                                    <img src="https://images.unsplash.com/photo-1487821619655-4943a3202619?q=80&w=1000" alt="Case File">
                                </div>
                                <div class="case-file-content">
                                    <span class="case-file-category">True Crime</span>
                                    <h3 class="case-file-title">The Zodiac Killer</h3>
                                    <p class="case-file-meta">Archived: April 12, 2025</p>
                                </div>
                            </div>
                            
                            <div class="case-file-item">
                                <div class="case-file-img">
                                    <img src="https://images.unsplash.com/photo-1600028814234-74d89d77ea21?q=80&w=1000" alt="Case File">
                                </div>
                                <div class="case-file-content">
                                    <span class="case-file-category">Cold Case</span>
                                    <h3 class="case-file-title">The Black Dahlia</h3>
                                    <p class="case-file-meta">Archived: April 10, 2025</p>
                                </div>
                            </div>
                            
                            <div class="case-file-item">
                                <div class="case-file-img">
                                    <img src="https://images.unsplash.com/photo-1580137189272-c9379f8864fd?q=80&w=1000" alt="Case File">
                                </div>
                                <div class="case-file-content">
                                    <span class="case-file-category">Unsolved</span>
                                    <h3 class="case-file-title">The Somerton Man</h3>
                                    <p class="case-file-meta">Archived: April 5, 2025</p>
                                </div>
                            </div>
                        </div>
                        <div class="fingerprint-bg"></div>
                    </div>
                    
                    <!-- Evidence Logs Tab -->
                    <div class="tab-content" id="evidence-logs">
                        <h3 class="dossier-section-title">EVIDENCE CATALOG</h3>
                        <div class="case-files-grid">
                            <div class="case-file-item">
                                <div class="case-file-img">
                                    <img src="https://images.unsplash.com/photo-1485846234645-a62644f84728?q=80&w=1000" alt="Evidence Log">
                                </div>
                                <div class="case-file-content">
                                    <span class="case-file-category">Film Evidence</span>
                                    <h3 class="case-file-title">Knives Out</h3>
                                    <p class="case-file-meta">Analysis Rating: <span class="star-rating">★★★★★</span></p>
                                </div>
                            </div>
                            
                            <div class="case-file-item">
                                <div class="case-file-img">
                                    <img src="https://images.unsplash.com/photo-1536440136628-849c177e76a1?q=80&w=1000" alt="Evidence Log">
                                </div>
                                <div class="case-file-content">
                                    <span class="case-file-category">Film Evidence</span>
                                    <h3 class="case-file-title">Shutter Island</h3>
                                    <p class="case-file-meta">Analysis Rating: <span class="star-rating">★★★★☆</span></p>
                                </div>
                            </div>
                            
                            <div class="case-file-item">
                                <div class="case-file-img">
                                    <img src="https://images.unsplash.com/photo-1478720568477-152d9b164e26?q=80&w=1000" alt="Evidence Log">
                                </div>
                                <div class="case-file-content">
                                    <span class="case-file-category">Film Evidence</span>
                                    <h3 class="case-file-title">Gone Girl</h3>
                                    <p class="case-file-meta">Analysis Rating: <span class="star-rating">★★★★★</span></p>
                                </div>
                            </div>
                        </div>
                        <div class="fingerprint-bg"></div>
                    </div>
                    
                    <!-- Agent Settings Tab -->
                    <div class="tab-content" id="agent-settings">
                        <h3 class="dossier-section-title">AGENT FILE MAINTENANCE</h3>
                        <form id="profile-settings-form">
                            <div class="form-group">
                                <label for="display-name">Agent Name</label>
                                <input type="text" id="display-name" name="display-name" value="Jane Doe" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="username">Codename</label>
                                <input type="text" id="username" name="username" value="mysterylover" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="email">Secure Contact</label>
                                <input type="email" id="email" name="email" value="jane.doe@example.com" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="bio">Field Notes</label>
                                <textarea id="bio" name="bio" rows="4" class="form-control">Mystery enthusiast and amateur detective. I love solving puzzles and reading true crime stories.</textarea>
                            </div>
                            <div class="form-group">
                                <label for="new-password">New Security Key (leave blank to keep current)</label>
                                <input type="password" id="new-password" name="new-password" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="confirm-password">Verify Security Key</label>
                                <input type="password" id="confirm-password" name="confirm-password" class="form-control">
                            </div>
                            <button type="submit" class="edit-profile-btn">
                                <i class="fas fa-save"></i> Submit Updates
                            </button>
                        </form>
                        <div class="fingerprint-bg"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Navigation</h3>
                    <ul class="footer-links">
                        <li><a href="../index.html">Home Base</a></li>
                        <li><a href="../games/game1.html">Field Operations</a></li>
                        <li><a href="../blog/blog.html">Case Files</a></li>
                        <li><a href="../movies/movies.html">Evidence Archive</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Legal Notice</h3>
                    <p>All case files contained herein are property of Mystery Hub Investigations. Unauthorized access will be prosecuted.</p>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2025 Mystery Hub | Bintu Jalloh & Michelle Lawson</p>
            </div>
        </div>
    </footer>
    
    <script>
        // Tab switching functionality
        document.addEventListener('DOMContentLoaded', function() {
            const tabs = document.querySelectorAll('.dossier-tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to current tab and content
                    this.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Load user profile data from backend
            fetchProfileData();
            
            // Form submission handling
            const profileForm = document.getElementById('profile-form');
            if (profileForm) {
                profileForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // Create FormData object to handle file upload
                    const formData = new FormData(this);
                    
                    // Add user ID to form data
                    const userId = localStorage.getItem('userId');
                    if (userId) {
                        formData.append('user_id', userId);
                    }
                    
                    // Send the form data to the server
                    fetch('../Backend/Php/update_profile.php', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Show success message
                            showMessage('Profile updated successfully!', 'success');
                            
                            // Update the profile picture if it was changed
                            if (data.profile_picture) {
                                document.getElementById('profile-picture').src = data.profile_picture;
                            }
                            
                            // Close the modal
                            const modal = document.getElementById('profile-modal');
                            if (modal) {
                                modal.style.display = 'none';
                            }
                            
                            // Refresh the profile data
                            loadProfileData();
                        } else {
                            // Show error message
                            showMessage(data.message || 'Failed to update profile. Please try again.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error updating profile:', error);
                        showMessage('An error occurred while updating your profile. Please try again.', 'error');
                    });
                });
            }
            
            // Get user ID from localStorage or session
            const userId = localStorage.getItem('userId');
            if (userId) {
                loadProfilePictureFromJson(userId);
            }
        });
        
        // Fetch user profile data from the backend API
        function fetchProfileData() {
            // Display loading state
            displayFlashMessage('info', 'Loading agent data...', false);
            
            fetch('../Backend/Php/get_profile_data.php')
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        // If not logged in, redirect to login page
                        if (data.redirect) {
                            window.location.href = data.redirect;
                            return;
                        }
                        displayFlashMessage('error', data.message || 'Failed to load profile data.');
                        return;
                    }
                    
                    // Update profile data in the UI
                    updateProfileUI(data);
                    
                    // Display any flash messages
                    if (data.flash_messages) {
                        for (const type in data.flash_messages) {
                            for (const message of data.flash_messages[type]) {
                                displayFlashMessage(type, message);
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching profile data:', error);
                    displayFlashMessage('error', 'Failed to connect to the server. Please try again later.');
                });
        }
        
        // Update the UI with profile data
        function updateProfileUI(userData) {
            document.getElementById('firstname').value = userData.firstname || '';
            document.getElementById('lastname').value = userData.lastname || '';
            document.getElementById('email').value = userData.email || '';
            document.getElementById('username').value = userData.username || '';
            document.getElementById('expertise').value = userData.expertise || '';
            document.getElementById('bio').value = userData.bio || '';
            
            // Update profile picture
            if (userData.profile_picture) {
                document.getElementById('profile-picture').src = userData.profile_picture;
            }
        }
        
        // Display flash messages
        function displayFlashMessage(type, message, autoHide = true) {
            // Create container if it doesn't exist
            let flashContainer = document.querySelector('.flash-messages');
            if (!flashContainer) {
                flashContainer = document.createElement('div');
                flashContainer.className = 'flash-messages';
                document.body.insertBefore(flashContainer, document.body.firstChild);
                
                // Add styles if not already present
                if (!document.getElementById('flash-message-styles')) {
                    const style = document.createElement('style');
                    style.id = 'flash-message-styles';
                    style.textContent = `
                        .flash-messages {
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            max-width: 350px;
                            z-index: 9999;
                            font-family: var(--typewriter-font, 'Special Elite', courier, monospace);
                        }
                        .flash-message {
                            margin-bottom: 10px;
                            padding: 12px 15px;
                            border-radius: 4px;
                            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                            position: relative;
                            animation: slidein 0.3s ease-in-out;
                            transition: opacity 0.3s ease;
                        }
                        .flash-success {
                            background-color: #d4edda;
                            border-left: 4px solid #28a745;
                            color: #155724;
                        }
                        .flash-error {
                            background-color: #f8d7da;
                            border-left: 4px solid #dc3545;
                            color: #721c24;
                        }
                        .flash-info {
                            background-color: #d1ecf1;
                            border-left: 4px solid #17a2b8;
                            color: #0c5460;
                        }
                        .flash-close {
                            position: absolute;
                            top: 8px;
                            right: 8px;
                            cursor: pointer;
                            opacity: 0.7;
                            transition: opacity 0.2s;
                        }
                        .flash-close:hover {
                            opacity: 1;
                        }
                        @keyframes slidein {
                            from {
                                transform: translateX(30px);
                                opacity: 0;
                            }
                            to {
                                transform: translateX(0);
                                opacity: 1;
                            }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }
            
            // Create message element
            const messageElement = document.createElement('div');
            messageElement.className = `flash-message flash-${type}`;
            
            // Add icon based on message type
            let icon = '';
            switch (type) {
                case 'success':
                    icon = '<i class="fas fa-check-circle"></i>';
                    break;
                case 'error':
                    icon = '<i class="fas fa-exclamation-circle"></i>';
                    break;
                case 'info':
                    icon = '<i class="fas fa-info-circle"></i>';
                    break;
            }
            
            messageElement.innerHTML = `${icon} ${message}<span class="flash-close"><i class="fas fa-times"></i></span>`;
            flashContainer.appendChild(messageElement);
            
            // Add close button functionality
            const closeButton = messageElement.querySelector('.flash-close');
            closeButton.addEventListener('click', function() {
                messageElement.style.opacity = '0';
                setTimeout(() => {
                    messageElement.remove();
                }, 300);
            });
            
            // Auto-hide after 5 seconds
            if (autoHide) {
                setTimeout(function() {
                    if (messageElement.parentElement) {
                        messageElement.style.opacity = '0';
                        setTimeout(() => {
                            if (messageElement.parentElement) {
                                messageElement.remove();
                            }
                        }, 300);
                    }
                }, 5000);
            }
            
            return messageElement;
        }

        // This is the functionality for the edit profile modal
        const modal = document.getElementById('editProfileModal');
        const closeModalBtn = document.querySelector('.close-modal');
        const cancelBtn = document.getElementById('cancel-edit-btn');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const submitBtn = document.getElementById('submit-btn');

        editProfileBtn.addEventListener('click', () => {
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            console.log('edit profile button clicked');
            // Add fade-in and slide-in animations
            modal.style.opacity = '0';
            modal.style.transform = 'translateY(-100px)';
            setTimeout(() => {
                modal.style.opacity = '1';
                modal.style.transform = 'translateY(0)';
            }, 100);

            // fill the button with the current profile data
            fetch('../Backend/Php/get_profile_data.php')
                .then(response => response.json())
                .then(data => {
                    if( data.user) {
                        document.getElementById('firstname').value = data.user.firstname;
                        document.getElementById('lastname').value = data.user.lastname;
                        document.getElementById('email').value = data.user.email;
                        document.getElementById('username').value = data.user.username;
                        document.getElementById('expertise').value = data.user.expertise;
                        document.getElementById('bio').value = data.user.bio || '';
                    }
                })
                .catch(error => console.error("Error fetching profile data:", error));
        });

        function closeModal() {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        closeModalBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);

        window.addEventListener('click', (e) => {
            if(event.key === 'Escape' &&  modal.style.display === 'block') {
                closeModal();
            }
        });

        submitBtn.addEventListener('click', () => {
            console.log('submit button clicked');
            const formData = new FormData(modal.querySelector('form'));
            const updatedData = Object.fromEntries(formData);

            console.log(updatedData);

            // Update the profile data in the backend
            fetch('../Backend/Php/update_profile.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    displayFlashMessage('success', data.message || 'Profile updated successfully!');
                    closeModal();
                    
                    // Reload the profile picture after successful update
                    const userId = localStorage.getItem('userId');
                    if (userId) {
                        console.log('Reloading profile picture after update');
                        loadProfilePictureFromJson(userId);
                    }
                } else {
                    displayFlashMessage('error', data.message || 'Failed to update profile.');
                }
            })
        }) 

        // Function to load profile picture from JSON data
        function loadProfilePictureFromJson(userId) {
            // Get the profile picture display element
            const profilePictureDisplay = document.getElementById('profile-picture-display');
            
            // Check if the element exists
            if (!profilePictureDisplay) {
                console.error('Profile picture display element not found');
                return;
            }
            
            // Display loading state
            profilePictureDisplay.src = '../profile_pics/default-profile.jpg';
            
            // Fetch user data from JSON file
            fetch('../Backend/Data/users/users.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch user data');
                    }
                    return response.json();
                })
                .then(data => {
                    // Find the user with the matching ID
                    const user = data.find(user => user.id === userId);
                    
                    if (user && user.profile_picture) {
                        // Update the profile picture
                        profilePictureDisplay.src = user.profile_picture;
                        console.log('Profile picture updated:', user.profile_picture);
                    } else {
                        console.log('No profile picture found for user:', userId);
                    }
                })
                .catch(error => {
                    console.error('Error loading profile picture:', error);
                    // Keep the default image if there's an error
                });
        }
    </script>
</body>
</html>
